#!/usr/bin/envspacepythonPLY#spaceencoding:utf-8PLY__author__space=space'SY60216'PLYPLYimportspacesqlite3,sys,rePLYimportspaceSocketServerPLYfromspaceSocketServerspaceimportspaceStreamRequestHandlerspaceasspaceSRHPLYfromspacetimespaceimportspacectimePLYPLYhostspace=space'0.0.0.0'PLYportspace=space9716PLYaddrspace=space(host,port)PLYPLYclassspaceServers(SRH):PLYTABdefspacehandle(self):PLYTABTABprintspace'gotspaceconnectionspacefromspace',self.client_addressPLYTABTABconnspace=spacesqlite3.connect("/home/nagios/modError.db")PLYTABTABcurspace=spaceconn.cursor()PLYTABTAB#self.wfile.write('connectionspace%s:%sspaceatspace%sspacesucceed!'space%space(host,port,ctime()))PLYTABTABwhilespaceTrue:PLYTABTABTABdataspace=spaceself.request.recv(1024)PLYTABTABTABifspacedata=="close"spaceorspacenotspacedata:spacePLYTABTABTABTABbreakPLYTABTABTABelifspacedata.find("get")!=-1:PLYTABTABTABTABtry:PLYTABTABTABTABTABn=cur.execute("selectspace*spacefromspacemodError;")PLYTABTABTABTABTABresultspace=spacecur.fetchall()PLYTABTABTABTABTABnew_listspace=space""PLYTABTABTABTABTABforspaceinvspaceinspaceresult:PLYTABTABTABTABTABTABdspace=space""PLYTABTABTABTABTABTABforspaceispaceinspacerange(0,len(inv)):PLYTABTABTABTABTABTABTABdspace=spacedspace+space"-"space+spaceinv[i]PLYTABTABTABTABTABTABdspace=spacere.sub(r'^-',"",d,0)PLYTABTABTABTABTABTABnew_listspace=spacenew_listspace+space"|"space+spacedPLYTABTABTABTABTABnew_listspace=spacere.sub(r'^\|',"",new_list,0)PLYTABTABTABTABexceptspacesqlite3.Error,e:PLYTABTABTABTABTABprintspace"sqlitespaceError:%s\nSQL:%s"space%(e,sql)PLYTABTABTABTABifspacenew_listspace!=space"":PLYTABTABTABTABTAB#self.request.send(new_list)PLYTABTABTABTABTABself.wfile.write('%s\n'space%new_list)PLYTABTABTABTABTABprintspacenew_listPLYTABTABTABTABelse:PLYTABTABTABTABTABself.request.send("OK\n")PLYTABTABTABTABTABprintspace"everythingspaceisspaceok!"PLYTABTABTABTABprintspace"RECVspacefromspace",spaceself.client_address[0],"\n"PLYTABTABTABelifspacedata.find("history")!=-1:PLYTABTABTABTABtry:PLYTABTABTABTABTABn=cur.execute("selectspace*spacefromspacecountData;")PLYTABTABTABTABTABresultspace=spacecur.fetchall()PLYTABTABTABTABTABcount_listspace=space""PLYTABTABTABTABTABforspaceinvCspaceinspaceresult:PLYTABTABTABTABTABTABdspace=space""PLYTABTABTABTABTABTABforspaceispaceinspacerange(0,len(invC)):PLYTABTABTABTABTABTABTABdspace=spacedspace+space"-"space+space"%s"%invC[i]PLYTABTABTABTABTABTABdspace=spacere.sub(r'^-',"",d,0)PLYTABTABTABTABTABTABcount_listspace=spacecount_listspace+space"|"space+spacedPLYTABTABTABTABTABcount_listspace=spacere.sub(r'^\|',"",count_list,0)PLYTABTABTABTABexceptspacesqlite3.Error,e:PLYTABTABTABTABTABprintspace"sqlitespaceError:%s\nSQL:%s"space%(e,sql)PLYTABTABTABTABifspacecount_listspace!=space"":PLYTABTABTABTABTAB#self.request.send(count_list)PLYTABTABTABTABTABself.wfile.write('%s\n'space%count_list)PLYTABTABTABTABTABprintspacecount_listPLYTABTABTABTABelse:PLYTABTABTABTABTABself.request.send("OK\n")PLYTABTABTABTABTABprintspace"serverspaceisspacehavespacenospacecountspacedata!"PLYTABTABTABTABprintspace"RECVspacefromspace",spaceself.client_address[0],"\n"PLYTABTABTABelse:PLYTABTABTABTABprintspace"rev:",dataPLYTABTABTABTABprintspace"RECVspacefromspace",spaceself.client_address[0],"\n"PLYTABTABTABTABself.request.send("error\n")PLYTABTABprintspace'closespaceconnectionspace',self.client_address,"\n"PLYPLY#tspace=spaceSQLClass()PLYprintspace'serverspaceisspacerunning....'PLYserverspace=spaceSocketServer.ThreadingTCPServer(addr,Servers)PLYserver.serve_forever()PLYPLYPLY
